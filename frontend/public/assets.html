<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Financial Tracker - Assets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/">Financial Tracker</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/assets.html">Assets</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header"><h2>Upload Stocks CSV</h2></div>
                    <div class="card-body">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <input type="file" name="file" class="form-control-file" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                        <div id="upload-status" class="mt-3"></div>
                        <p class="mt-3"><small>CSV format: symbol,quantity,purchase_price,purchase_date,currency,purchase_fx_rate</small></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2>Assets</h2>
                            <div class="settings-container">
                                <label for="date-format-toggle" class="mr-2">Date Format:</label>
                                <select id="date-format-toggle" class="form-control-sm">
                                    <option value="US">US (MM/DD/YYYY)</option>
                                    <option value="UK">UK (DD/MM/YYYY)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="assets-table-container" class="table-responsive">
                            <!-- Asset table will be injected here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateFormatToggle = document.getElementById('date-format-toggle');
            const savedFormat = localStorage.getItem('dateFormat') || 'US';
            dateFormatToggle.value = savedFormat;

            dateFormatToggle.addEventListener('change', function() {
                localStorage.setItem('dateFormat', this.value);
                formatAllDates();
            });

            fetchAssets();

            const uploadForm = document.getElementById('upload-form');
            const uploadStatus = document.getElementById('upload-status');

            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(uploadForm);
                uploadStatus.textContent = 'Uploading...';

                fetch('/api/upload/stocks', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        uploadStatus.textContent = data.message;
                        fetchAssets(); // Refresh assets list
                    } else {
                        uploadStatus.textContent = 'Error: ' + (data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    uploadStatus.textContent = 'Upload failed.';
                });
            });
        });

        function fetchAssets() {
            const tableContainer = document.getElementById('assets-table-container');
            tableContainer.innerHTML = '<p>Loading assets...</p>';

            fetch('/api/assets')
                .then(response => {
                    if (!response.ok) {
                        // Try to get a more detailed error message from the response body
                        return response.text().then(text => { 
                            let errorMsg = `HTTP error ${response.status}`;
                            try {
                                const errJson = JSON.parse(text);
                                errorMsg = errJson.error || text;
                            } catch (e) {
                                errorMsg = text;
                            }
                            throw new Error(errorMsg);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || data.length === 0) {
                        tableContainer.innerHTML = '<p>No assets found. Upload a CSV file to get started.</p>';
                        return;
                    }

                    let tableRows = '';
                    data.forEach(asset => {
                        tableRows += `
                            <tr>
                                <td>${asset.name || 'N/A'}</td>
                                <td>${asset.symbol}</td>
                                <td>${asset.quantity || 0}</td>
                                <td>${asset.purchase_price ? asset.purchase_price.toFixed(2) : 'N/A'}</td>
                                <td class="purchase-date">${asset.purchase_date || 'N/A'}</td>
                                <td>${asset.currency}</td>
                                <td>${asset.current_value ? asset.current_value.toFixed(2) : 'N/A'}</td>
                                <td>${asset.asset_growth_usd.toFixed(2)}</td>
                                <td>${asset.currency_gain_usd.toFixed(2)}</td>
                                <td>${asset.dividend_income_usd.toFixed(2)}</td>
                            </tr>
                        `;
                    });

                    tableContainer.innerHTML = `
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Purchase Price</th>
                                    <th>Purchase Date</th>
                                    <th>Currency</th>
                                    <th>Current Value</th>
                                    <th>Asset Growth (USD)</th>
                                    <th>Currency Gain (USD)</th>
                                    <th>Dividend Income (USD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    `;
                    formatAllDates();
                })
                .catch(error => {
                    tableContainer.innerHTML = `<div class="alert alert-danger" role="alert">${error.message}</div>`;
                    console.error('Error fetching assets:', error);
                });
        }

        function formatAllDates() {
            const format = localStorage.getItem('dateFormat') || 'US';
            document.querySelectorAll('.purchase-date').forEach(td => {
                const isoDate = td.textContent;
                if (isoDate && isoDate !== 'N/A') {
                    const parts = isoDate.split('-');
                    if (parts.length === 3) {
                        const year = parts[0];
                        const month = parts[1];
                        const day = parts[2];
                        if (format === 'US') {
                            td.textContent = `${month}/${day}/${year}`;
                        } else { // UK format
                            td.textContent = `${day}/${month}/${year}`;
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
